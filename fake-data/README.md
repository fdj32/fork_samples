# PostgreSQL Replication

## Based on WAL (Write-Ahead Log) File

### PostgreSQL package
Version: 13.3-2
```
wget https://get.enterprisedb.com/postgresql/postgresql-13.3-2-windows-x64-binaries.zip
```
### About RunHiddenConsole
https://www.nginx.com/resources/wiki/start/topics/examples/phpfastcgionwindows/  
https://redmine.lighttpd.net/attachments/660/RunHiddenConsole.zip  
https://redmine.lighttpd.net/attachments/download/660/RunHiddenConsole.zip  

### Working Directory
Master: C:/Users/nfeng/tools/pgsql

Replica: C:/Users/nfeng/tools/pgsql2
### Scripts
#### INIT DB
```
C:/Users/nfeng/tools/pgsql/bin/pg_ctl init -D C:/Users/nfeng/tools/pgsql/data
```
#### Start Master DB
```
C:/Users/nfeng/tools/RunHiddenConsole C:/Users/nfeng/tools/pgsql/bin/pg_ctl -D C:/Users/nfeng/tools/pgsql/data -l C:/Users/nfeng/pgsql.log start
```
#### Stop Master DB
```
C:/Users/nfeng/tools/RunHiddenConsole C:/Users/nfeng/tools/pgsql/bin/pg_ctl -D C:/Users/nfeng/tools/pgsql/data stop
```
#### Login Master DB
```
C:/Users/nfeng/tools/pgsql/bin/psql -dpostgres
```
#### Create Super User On Master DB
```
create user root superuser password 'root';
```
#### Login Master DB with root
```
C:/Users/nfeng/tools/pgsql/bin/psql -dpostgres -Uroot -W
Type: root
```
#### Login with host
```
C:/Users/nfeng/tools/pgsql/bin/psql -dpostgres -hlocalhost -p5432 -Uroot -W
C:/Users/nfeng/tools/pgsql/bin/psql -dpostgres -h127.0.0.1 -p5432 -Uroot -W
C:/Users/nfeng/tools/pgsql/bin/psql -dpostgres -h10.110.14.166 -p5432 -Uroot -W
```
-h10.110.14.166 will fail, because "#listen_addresses = 'localhost'",
listen_addresses = '*' can allow it
#### Checking Status
```
netstat -an | grep LISTEN

netstat -an | grep 5432

tasklist | grep postgres

taskkill /f /im postgres
```
#### Backup from Master to Replica
Just stop master, then copy data folder to replica. And replace some settings in postgresql.conf. But remember to remove postmaster.opts and postmaster.pid.
#### Start Replica DB
```
C:/Users/nfeng/tools/RunHiddenConsole C:/Users/nfeng/tools/pgsql2/bin/pg_ctl -D C:/Users/nfeng/tools/pgsql2/data -l C:/Users/nfeng/pgsql2.log start
```
#### Stop Replica DB
```
C:/Users/nfeng/tools/RunHiddenConsole C:/Users/nfeng/tools/pgsql2/bin/pg_ctl -D C:/Users/nfeng/tools/pgsql2/data stop
```
#### Login on Replica
```
C:/Users/nfeng/tools/pgsql2/bin/psql -dpostgres -p15432

C:/Users/nfeng/tools/pgsql2/bin/psql -dpostgres -p15432 -Uroot -W
Type: root
```
### Configuration
| Field\Server | Master | Replica | Default |
| --- | --- | --- | --- |
| port | 5432 | 15432 | 5432 |
| archive_mode | on | off | off |
| archive_command | 'copy %p C:/Users/nfeng/tools/archivedir/%f' | '' | '' |
| restore_command | '' | 'copy C:/Users/nfeng/tools/archivedir/%f %p' | '' |
| archive_cleanup_command | '' | 'C:/Users/nfeng/tools/pgsql2/bin/pg_archivecleanup C:/Users/nfeng/tools/archivedir %r' | '' |
| primary_conninfo | '' | 'host=127.0.0.1 port=5432 user=root password=root' | '' |

### Put file standby.signal in Replica data/
```
touch C:/Users/nfeng/tools/pgsql2/data/standby.signal
```
[26.2.4. 建立一个后备服务器](http://www.postgres.cn/docs/12/warm-standby.html#STANDBY-SERVER-SETUP)  

### SQL
```
create table customer (
	id integer generated by default as identity,
	name varchar(32) not null,
	pwd varchar(255) not null,
	fname varchar(32) not null,
	lname varchar(32) not null,
	birth varchar(255) not null,
	weight varchar(255) not null,
	email varchar(255),
	primary key (id)
);

select count(1) from customer;

select * from customer order by id desc limit 10;

```
